<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Steffi LaZerte">
<meta name="dcterms.date" content="2024-02-09">

<title>Vulture Migration on Vancouver Island - Initial Exploration</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./02_calculate_metrics.html" rel="next">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./01_initial_exploration.html">Workflow</a></li><li class="breadcrumb-item"><a href="./01_initial_exploration.html">Initial Exploration</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Vulture Migration on Vancouver Island</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/steffilazerte/vulture_migration" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Workflow</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_initial_exploration.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Initial Exploration</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_calculate_metrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Calculate Metrics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analysis</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Appendicies</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./XX_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Setup</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./XX_citations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Citations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./XX_notes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Notes</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#load-clean-data" id="toc-load-clean-data" class="nav-link" data-scroll-target="#load-clean-data">Load &amp; Clean Data</a></li>
  <li><a href="#quick-look-at-the-data" id="toc-quick-look-at-the-data" class="nav-link" data-scroll-target="#quick-look-at-the-data">Quick look at the data</a></li>
  <li><a href="#questions" id="toc-questions" class="nav-link" data-scroll-target="#questions">Questions</a></li>
  <li><a href="#metrics-to-assess" id="toc-metrics-to-assess" class="nav-link" data-scroll-target="#metrics-to-assess">Metrics to assess</a></li>
  <li><a href="#how-to-calculate-dates-of-passage" id="toc-how-to-calculate-dates-of-passage" class="nav-link" data-scroll-target="#how-to-calculate-dates-of-passage">How to calculate dates of passage?</a>
  <ul class="collapse">
  <li><a href="#steffis-suggested-approach" id="toc-steffis-suggested-approach" class="nav-link" data-scroll-target="#steffis-suggested-approach">Steffi’s suggested approach</a></li>
  </ul></li>
  <li><a href="#gam" id="toc-gam" class="nav-link" data-scroll-target="#gam">Using GAM based appraoch</a>
  <ul class="collapse">
  <li><a href="#calculating-dates-of-passage" id="toc-calculating-dates-of-passage" class="nav-link" data-scroll-target="#calculating-dates-of-passage">Calculating dates of passage</a></li>
  <li><a href="#option-1-do-not-omit-resident-vultures" id="toc-option-1-do-not-omit-resident-vultures" class="nav-link" data-scroll-target="#option-1-do-not-omit-resident-vultures">Option 1: Do not omit resident vultures</a></li>
  <li><a href="#option-2-use-a-count-threshold-to-omit-dates-with-resident-vultures" id="toc-option-2-use-a-count-threshold-to-omit-dates-with-resident-vultures" class="nav-link" data-scroll-target="#option-2-use-a-count-threshold-to-omit-dates-with-resident-vultures">Option 2: Use a count threshold to omit dates with resident vultures</a></li>
  <li><a href="#option-3" id="toc-option-3" class="nav-link" data-scroll-target="#option-3">Option 3: Subtract the median resident count from all observations</a></li>
  <li><a href="#comparing-our-options" id="toc-comparing-our-options" class="nav-link" data-scroll-target="#comparing-our-options">Comparing our options</a></li>
  <li><a href="#steffis-suggested-approach-1" id="toc-steffis-suggested-approach-1" class="nav-link" data-scroll-target="#steffis-suggested-approach-1">Steffi’s suggested approach</a></li>
  </ul></li>
  <li><a href="#reproducibility" id="toc-reproducibility" class="nav-link" data-scroll-target="#reproducibility">Reproducibility</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/steffilazerte/vulture_migration/edit/main/01_initial_exploration.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/steffilazerte/vulture_migration/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./01_initial_exploration.html">Workflow</a></li><li class="breadcrumb-item"><a href="./01_initial_exploration.html">Initial Exploration</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Initial Exploration</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Steffi LaZerte </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 9, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>This is the initial exploration of Turkey Vulture kettling and migration behaviour above Rocky Point on southern Vancouver Island.</p>
<blockquote class="blockquote">
<p>Banding and observations start 1 hour before sunrise and commence for 6 hours. Blanks indicate no data, often because the banding station was not open at all due to rainy weather or closed early for similar reasons. In addition, the station is on Department of National Defence land, and blanks can arise when banders are excluded by DND. Unfortunately, this applies to the entire year of 2007. Zero values represent true zeros, the count was made but no vultures seen.</p>
</blockquote>
<p>Data values are daily estimates “of the greatest aggregation of vultures over Rocky Point that day during the station hours”.</p>
</section>
<section id="load-clean-data" class="level2">
<h2 class="anchored" data-anchor-id="load-clean-data">Load &amp; Clean Data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"XX_functions.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" aria-current="page">Load Data</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Quick Check</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="st">"Data/Raw/TUVU DET updated 1998-2023.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(v)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 27
  `day/year`          `1998` `1999` `2000` `2001` `2002` `2003` `2004` `2005`
  &lt;dttm&gt;               &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1 2023-07-23 00:00:00      4     NA      2      4      3      4      3      3
2 2023-07-24 00:00:00      7     NA      0      3      4      5      3      4
3 2023-07-25 00:00:00      4      6      2      3      7      4      5      6
4 2023-07-26 00:00:00      0      4      0      2      6      5      4      6
5 2023-07-27 00:00:00      0      7     NA      9      5      1      1      1
6 2023-07-28 00:00:00      1      4     NA     10      7      6      1      8
# ℹ 18 more variables: `2006` &lt;dbl&gt;, `2007` &lt;lgl&gt;, `2008` &lt;dbl&gt;, `2009` &lt;dbl&gt;,
#   `2010` &lt;dbl&gt;, `2011` &lt;dbl&gt;, `2012` &lt;dbl&gt;, `2013` &lt;dbl&gt;, `2014` &lt;dbl&gt;,
#   `2015` &lt;dbl&gt;, `2016` &lt;dbl&gt;, `2017` &lt;dbl&gt;, `2018` &lt;dbl&gt;, `2019` &lt;dbl&gt;,
#   `2020` &lt;dbl&gt;, `2021` &lt;dbl&gt;, `2022` &lt;dbl&gt;, `2023` &lt;dbl&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(v)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 27
  `day/year`          `1998` `1999` `2000` `2001` `2002` `2003` `2004` `2005`
  &lt;dttm&gt;               &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1 2023-10-16 00:00:00      0     NA      0     NA     25     NA    120      5
2 2023-10-17 00:00:00     NA     NA      4     NA     26     NA     NA     NA
3 2023-10-18 00:00:00     12     NA     NA     NA     14      6     26     10
4 2023-10-19 00:00:00     NA     18     NA     NA      8     NA     NA     NA
5 2023-10-20 00:00:00     NA     10     NA     NA     17     NA     NA     NA
6 2023-10-21 00:00:00     NA     NA     NA     NA      9     NA     NA     NA
# ℹ 18 more variables: `2006` &lt;dbl&gt;, `2007` &lt;lgl&gt;, `2008` &lt;dbl&gt;, `2009` &lt;dbl&gt;,
#   `2010` &lt;dbl&gt;, `2011` &lt;dbl&gt;, `2012` &lt;dbl&gt;, `2013` &lt;dbl&gt;, `2014` &lt;dbl&gt;,
#   `2015` &lt;dbl&gt;, `2016` &lt;dbl&gt;, `2017` &lt;dbl&gt;, `2018` &lt;dbl&gt;, `2019` &lt;dbl&gt;,
#   `2020` &lt;dbl&gt;, `2021` &lt;dbl&gt;, `2022` &lt;dbl&gt;, `2023` &lt;dbl&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Quick Clean</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Quick Check</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">rename</span>(v, <span class="at">date =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<p>Expect 2023 for all years, as original data doesn’t include year and R <em>must</em> have a year (this is corrected below).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>v</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 91 × 27
   date                `1998` `1999` `2000` `2001` `2002` `2003` `2004` `2005`
   &lt;dttm&gt;               &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
 1 2023-07-23 00:00:00      4     NA      2      4      3      4      3      3
 2 2023-07-24 00:00:00      7     NA      0      3      4      5      3      4
 3 2023-07-25 00:00:00      4      6      2      3      7      4      5      6
 4 2023-07-26 00:00:00      0      4      0      2      6      5      4      6
 5 2023-07-27 00:00:00      0      7     NA      9      5      1      1      1
 6 2023-07-28 00:00:00      1      4     NA     10      7      6      1      8
 7 2023-07-29 00:00:00      0      5      0      2      6      1      3      1
 8 2023-07-30 00:00:00      3     34      3      0      2      1      3      4
 9 2023-07-31 00:00:00      4     11      4      8      2      7      2      3
10 2023-08-01 00:00:00      6      5      0      2      6      5      3      4
# ℹ 81 more rows
# ℹ 18 more variables: `2006` &lt;dbl&gt;, `2007` &lt;lgl&gt;, `2008` &lt;dbl&gt;, `2009` &lt;dbl&gt;,
#   `2010` &lt;dbl&gt;, `2011` &lt;dbl&gt;, `2012` &lt;dbl&gt;, `2013` &lt;dbl&gt;, `2014` &lt;dbl&gt;,
#   `2015` &lt;dbl&gt;, `2016` &lt;dbl&gt;, `2017` &lt;dbl&gt;, `2018` &lt;dbl&gt;, `2019` &lt;dbl&gt;,
#   `2020` &lt;dbl&gt;, `2021` &lt;dbl&gt;, `2022` &lt;dbl&gt;, `2023` &lt;dbl&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">Re-arrange</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">Quick Check</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">pivot_longer</span>(v, <span class="sc">-</span>date, <span class="at">names_to =</span> <span class="st">"year"</span>, <span class="at">values_to =</span> <span class="st">"count"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">year</span>(v<span class="sc">$</span>date) <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(v<span class="sc">$</span>year)  <span class="co"># Fix years for each date</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">mutate</span>(v, <span class="at">date =</span> <span class="fu">as_date</span>(date), <span class="at">doy =</span> <span class="fu">yday</span>(date))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<p>Correct year on all dates now.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>v</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,366 × 4
   date       year  count   doy
   &lt;date&gt;     &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 1998-07-23 1998      4   204
 2 1999-07-23 1999     NA   204
 3 2000-07-23 2000      2   205
 4 2001-07-23 2001      4   204
 5 2002-07-23 2002      3   204
 6 2003-07-23 2003      4   204
 7 2004-07-23 2004      3   205
 8 2005-07-23 2005      3   204
 9 2006-07-23 2006      4   204
10 2007-07-23 2007     NA   204
# ℹ 2,356 more rows</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="quick-look-at-the-data" class="level2">
<h2 class="anchored" data-anchor-id="quick-look-at-the-data">Quick look at the data</h2>
<p><strong>Too see full screen: Right-click and select “Open Image in New Tab” (or similar)</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(v, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> count, <span class="at">group =</span> year, <span class="at">colour =</span> year)) <span class="sc">+</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_smooth</span>(<span class="at">method =</span> <span class="st">"gam"</span>, <span class="at">formula =</span> y <span class="sc">~</span> <span class="fu">s</span>(x, <span class="at">k =</span> <span class="dv">10</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>year, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_viridis_d</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="01_initial_exploration_files/figure-html/unnamed-chunk-8-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="01_initial_exploration_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="1536"></a></p>
</figure>
</div>
</div>
</div>
<p>Save this formatted data for later use</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(v, <span class="st">"Data/Datasets/vultures_clean_2023.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="questions" class="level2">
<h2 class="anchored" data-anchor-id="questions">Questions</h2>
<ol type="1">
<li>Has the timing of kettle formation and migration has changed over the years?
<ul>
<li>If so, what is the pattern of change? (Direction and magnitude of change)</li>
<li>If not, document temporal distribution of numbers</li>
</ul></li>
<li>Has the number of birds in the kettles changed over time?
<ul>
<li>may indicate population trends</li>
<li>complicated by accumulating birds over days when the weather conditions are not suitable for passing over the strait</li>
<li>potentially look at weather effects…</li>
</ul></li>
</ol>
</section>
<section id="metrics-to-assess" class="level2">
<h2 class="anchored" data-anchor-id="metrics-to-assess">Metrics to assess</h2>
<p>To answer these questions we need to summarize the counts into specific metrics representing the timing of migration.</p>
<p>Specifically, we would like to calculate the</p>
<ul>
<li>dates of 5%, 25%, 50%, 75%, and 95% of the kettle numbers</li>
<li>duration of passage - No.&nbsp;days between 5% and 95%</li>
<li>duration of peak passage - No.&nbsp;days between 25% and 75%</li>
</ul>
<p>Population size (no. vultures in aggregations)</p>
<ul>
<li>maximum</li>
<li>cumulative</li>
<li>number at peak passage (max? range? median?)</li>
<li>mean/median number of locals</li>
</ul>
<p>Of these, the most important starting metrics are the <strong>dates of 5%, 25%, 50%, 75%, and 95% of the kettle numbers</strong>. These dates will define migration phenology as well as local vs.&nbsp;migrating counts. All other calculations can be performed using these values and the raw data.</p>
</section>
<section id="how-to-calculate-dates-of-passage" class="level2">
<h2 class="anchored" data-anchor-id="how-to-calculate-dates-of-passage">How to calculate dates of passage?</h2>
<ul>
<li>Don suggested following methodology from Allcock et al 2022
<ul>
<li>“fit a curve to the data for each year and use it to estimate …”</li>
</ul></li>
<li>Allcock et al 2022 “modelled optimal Gaussian functions to describe the migration phenology for each species – year combination in our dataset using Markhov Chain Monte Carlo (MCMC) techniques”.</li>
<li>They say that “Gaussian functions … often outperform General Additive Models (Linden et al., 2016)”</li>
</ul>
<p><strong>I like this approach in general, but I’m not convinced that we can’t/shouldn’t use GAMs.</strong></p>
<p>In <a href="https://onlinelibrary.wiley.com/doi/epdf/10.1111/jav.00994">Linden et al.</a>, they restricted the GAM models’ effective degrees of freedom (which isn’t common, usually they are determined by the modelling procedure) and note that if they didn’t restrict them, “GAMs would have been preferred in 73% of the cases”.</p>
<p>The argument for restricting GAMS was to make the comparison among models possible as the “estimation of [effective] degrees of freedom [in a GAM] is similar to a model selection procedure”. This would have invalidated their use of the information theoretic approach for model comparison.</p>
<p>I still think we should use GAMs, because</p>
<ol type="1">
<li>We are using this to calculate metrics and as long as the model fits the data, is consistent and replicable, it doesn’t really matter how we get there (i.e.&nbsp;there’s no reason to not use the best GAM method with built-in model selection).</li>
<li>We are looking at a single species and so can assess each year to make sure it looks right.</li>
<li>I am familiar with GAMs, but have no experience with MCMC techniques to model Gaussian functions.</li>
<li>I don’t think that Linden et al.&nbsp;really demonstrated that GAMs are ‘bad’ to use.</li>
</ol>
<section id="steffis-suggested-approach" class="level3">
<h3 class="anchored" data-anchor-id="steffis-suggested-approach">Steffi’s suggested approach</h3>
<p>We use GAMs to model each year individually. From the predicted data we calculate the cumulative counts and the points at which these counts hit 5%, 25%, 75%, 95% of the total (I think this is what Allcock et al mean by ‘bird-days’?).</p>
<p>However, we will need to think about how to handle the resident birds, as they may artificially inflate the cumulative counts prior to migration.</p>
</section>
</section>
<section id="gam" class="level2">
<h2 class="anchored" data-anchor-id="gam">Using GAM based appraoch</h2>
<p>For illustration and exploration of this approach, we’ll look at 2000.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true">Example GAM - 2000</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false">Model summary</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-3" role="tab" aria-controls="tabset-4-3" aria-selected="false">Model evaluation</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<ul>
<li>Negative binomial model fits the count data with overdispersion</li>
<li>Use Restricted Maximum Likelihood (“Most likely to give you reliable, stable results”<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>)</li>
<li>We smooth (<code>s()</code>) over <code>doy</code> (day of year) to account for non-linear migration patterns</li>
<li>We set <code>k = 10</code> (up to 10 basis functions; we want enough to make sure we capture the patterns, but too many will slow things down).</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">gam</span>(count <span class="sc">~</span> <span class="fu">s</span>(doy, <span class="at">k =</span> <span class="dv">10</span>), <span class="at">data =</span> <span class="fu">filter</span>(v, year <span class="sc">==</span> <span class="dv">2000</span>), </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">method =</span> <span class="st">"REML"</span>, <span class="at">family =</span> <span class="st">"nb"</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(g, <span class="at">shade =</span> <span class="cn">TRUE</span>, <span class="at">trans =</span> exp, <span class="at">residuals =</span> <span class="cn">TRUE</span>, <span class="at">pch =</span> <span class="dv">20</span>, </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">shift =</span> <span class="fu">coef</span>(g)[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="01_initial_exploration_files/figure-html/unnamed-chunk-10-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="01_initial_exploration_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<p>Not really necessary for us to evaluate, but the <code>s(doy)</code> value indicates that we have a signifcant pattern, and the fact that the <code>edf</code> value is less than our <code>k = 10</code>, is good.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: Negative Binomial(1.117) 
Link function: log 

Formula:
count ~ s(doy, k = 10)

Parametric coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)    2.338      0.122   19.16   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
         edf Ref.df Chi.sq p-value    
s(doy) 5.482  6.627  170.7  &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  0.407   Deviance explained = 71.2%
-REML = 267.73  Scale est. = 1         n = 75</code></pre>
</div>
</div>
</div>
<div id="tabset-4-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-3-tab">
<p>Quick checks to ensure model is valid.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>p0 <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gam.check</span>(g, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="01_initial_exploration_files/figure-html/unnamed-chunk-12-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="01_initial_exploration_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Method: REML   Optimizer: outer newton
full convergence after 4 iterations.
Gradient range [9.247488e-07,1.632843e-06]
(score 267.7298 &amp; scale 1).
Hessian positive definite, eigenvalue range [2.251584,28.18106].
Model rank =  10 / 10 

Basis dimension (k) checking results. Low p-value (k-index&lt;1) may
indicate that k is too low, especially if edf is close to k'.

         k'  edf k-index p-value
s(doy) 9.00 5.48    1.01    0.81</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(p0)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> DHARMa<span class="sc">::</span><span class="fu">simulateResiduals</span>(g, <span class="at">plot =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="01_initial_exploration_files/figure-html/unnamed-chunk-12-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="01_initial_exploration_files/figure-html/unnamed-chunk-12-2.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<section id="calculating-dates-of-passage" class="level3">
<h3 class="anchored" data-anchor-id="calculating-dates-of-passage">Calculating dates of passage</h3>
<p>First create data set of predicted GAM model outputs across the entire date range.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>doy <span class="ot">&lt;-</span> <span class="fu">min</span>(g<span class="sc">$</span>model<span class="sc">$</span>doy)<span class="sc">:</span><span class="fu">max</span>(g<span class="sc">$</span>model<span class="sc">$</span>doy)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">predict</span>(g, <span class="at">newdata =</span> <span class="fu">list</span>(<span class="at">doy =</span> doy), <span class="at">type =</span> <span class="st">"response"</span>, <span class="at">se.fit =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">doy =</span> doy, <span class="at">count =</span> p<span class="sc">$</span>fit, <span class="at">se =</span> p<span class="sc">$</span>se) <span class="sc">|&gt;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ci99_upper =</span> count <span class="sc">+</span> se <span class="sc">*</span> <span class="fl">2.58</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">ci99_lower =</span> count <span class="sc">-</span> se <span class="sc">*</span> <span class="fl">2.58</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we’ll calculate percentiles based on cumulative counts. But there are several ways we can do this, depending how we want to account for resident vultures.</p>
<ul>
<li>Option 1: We do nothing</li>
<li>Option 2: We use the model’s CI 99% to find a threshold date before which we assume all observations are of local, resident vultures, after which is migration. We would then calculate cumulative counts only on data after this threshold)<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></li>
<li>Option 3: We calculate the median number of residents and simply subtract that from all counts before calculating our cumulative counts.</li>
</ul>
</section>
<section id="option-1-do-not-omit-resident-vultures" class="level3">
<h3 class="anchored" data-anchor-id="option-1-do-not-omit-resident-vultures">Option 1: Do not omit resident vultures</h3>
<ul>
<li>Use entire date range</li>
<li>No threshold cutoff</li>
<li>No subtraction of local counts</li>
<li>Calculate local counts from predicted data before Day 240</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>d_sum <span class="ot">&lt;-</span> <span class="fu">mutate</span>(d, <span class="at">count_sum =</span> <span class="fu">cumsum</span>(count))</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>dts <span class="ot">&lt;-</span> <span class="fu">calc_dates</span>(d_sum)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>dts_overall <span class="ot">&lt;-</span> <span class="fu">mutate</span>(dts, <span class="at">type =</span> <span class="st">"Option 1: No Adjustments"</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>residents <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(doy <span class="sc">&lt;</span> <span class="dv">240</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">res_pop_min =</span> <span class="fu">min</span>(count), <span class="at">res_pop_max =</span> <span class="fu">max</span>(count), </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">res_pop_median =</span> <span class="fu">median</span>(count), <span class="at">res_pop_mean =</span> <span class="fu">mean</span>(count)) <span class="sc">|&gt;</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), \(x) <span class="fu">round</span>(x, <span class="dv">1</span>)))</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">&lt;-</span> <span class="fu">plot_cum_explore</span>(<span class="at">d_sum =</span> d_sum, <span class="at">dts =</span> dts)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">&lt;-</span> <span class="fu">plot_model_explore</span>(<span class="at">d_raw =</span> g<span class="sc">$</span>model, <span class="at">d_pred =</span> d, <span class="at">dts =</span> dts, residents, <span class="at">resident_date =</span> <span class="dv">240</span>) <span class="sc">+</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">caption =</span> <span class="st">"Local count stats calculated up to Day 240"</span>)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>g_opt1 <span class="ot">&lt;-</span> g1 <span class="sc">/</span> g2 <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Option 1: No adjustments"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="option-2-use-a-count-threshold-to-omit-dates-with-resident-vultures" class="level3">
<h3 class="anchored" data-anchor-id="option-2-use-a-count-threshold-to-omit-dates-with-resident-vultures">Option 2: Use a count threshold to omit dates with resident vultures</h3>
<ul>
<li>Use the <em>minimum</em> value of the <em>upper limit</em> of the CI 99% to calculate a cutoff <strong>threshold</strong> (only consider dates &lt; 270 to avoid the end of migration tailing off)</li>
<li>The first date prior to migration which crosses this threshold <em>into migration</em> (i.e.&nbsp;avoids little blips up and down early in the year) is used as the <strong>threshold</strong></li>
<li>The data is filtered to include only dates <em>on or after this threshold</em></li>
<li>Then the percentiles are calculated based on cumulative counts in this subset</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>thresh <span class="ot">&lt;-</span> <span class="fu">filter</span>(d, doy <span class="sc">&lt;</span> <span class="dv">270</span>) <span class="sc">|&gt;</span> <span class="co"># Only consider pre-migration</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(doy)) <span class="sc">|&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(count <span class="sc">&lt;=</span> <span class="fu">min</span>(ci99_upper)) <span class="sc">|&gt;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(doy)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>thresh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 228</code></pre>
</div>
</div>
<blockquote class="blockquote">
<h4 id="what-is-the-min-of-the-upper-limit-of-the-ci-99" class="anchored">What is the min of the upper limit of the CI 99%?!?!?</h4>
<p>In the image below…</p>
<ul>
<li>the Grey ribbon represents the 99% Confidence Interval around the GAM model (grey line)</li>
<li>the upper limit of this <em>ribbon</em> is the upper limit of the 99% CI</li>
<li>the <em>minimum</em> of this value is the area on the figure where the upper edge of the ribbon is at it’s lowest value (large black point)</li>
<li>in this year/model, it’s occurs on the first day</li>
</ul>
<p><strong>How do we use this value?</strong></p>
<ul>
<li>the first value in the model (grey line) to cross this limit (dashed black line), identifies our threshold date (red dashed line)</li>
<li>we then use only the dates <em>after</em> this threshold to calculate migration metrics</li>
<li>we then use only the dates <em>before</em> this threshold to calculate local counts</li>
</ul>
</blockquote>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># g1 &lt;- ggplot(data = d, mapping = aes(x = doy, y = count)) +</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   theme_bw() +</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_ribbon(aes(ymin = ci99_lower, ymax = ci99_upper), fill = "grey50", alpha = 0.5) +</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_point(data = g$model) +</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line() +</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   coord_cartesian(xlim = c(204, 270)) +</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   labs(title = "Look only at beginning of migration")</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> d, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> doy, <span class="at">y =</span> count)) <span class="sc">+</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.85</span>), <span class="at">legend.title =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> ci99_lower, <span class="at">ymax =</span> ci99_upper), <span class="at">fill =</span> <span class="st">"grey50"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> g<span class="sc">$</span>model, <span class="at">colour =</span> <span class="st">"grey40"</span>) <span class="sc">+</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">colour =</span> <span class="st">"grey60"</span>) <span class="sc">+</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">204</span>, <span class="dv">245</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">40</span>)) <span class="sc">+</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">x =</span> d<span class="sc">$</span>doy[d<span class="sc">$</span>ci99_upper <span class="sc">==</span> <span class="fu">min</span>(d<span class="sc">$</span>ci99_upper)], </span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> <span class="fu">min</span>(d<span class="sc">$</span>ci99_upper), <span class="at">size =</span> <span class="dv">4</span>, <span class="fu">aes</span>(<span class="at">colour =</span> <span class="st">"Day with min 99% CI"</span>),</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>             <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">linetype =</span> <span class="dv">2</span>,</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">yintercept =</span> <span class="fu">min</span>(d<span class="sc">$</span>ci99_upper), <span class="at">colour =</span> <span class="st">"Min of upper 99% CI"</span>)) <span class="sc">+</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">linetype =</span> <span class="dv">2</span>,</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">xintercept =</span> thresh, <span class="at">colour =</span> <span class="st">"Threshold</span><span class="sc">\n</span><span class="st">(first date consistently</span><span class="sc">\n</span><span class="st">above min of upper 99% CI)"</span>)) <span class="sc">+</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"black"</span>, <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">colour =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">shape =</span> <span class="fu">c</span>(<span class="dv">19</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">size =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">linewidth =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.3</span>, <span class="fl">0.3</span>), <span class="at">linetype =</span> <span class="fu">c</span>(<span class="st">"solid"</span>, <span class="st">"dashed"</span>, <span class="st">"dashed"</span>)))) <span class="sc">+</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Find thresholds based on local counts"</span>, </span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Figure is model plot 'zoomed' into early season"</span>)</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>g2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="01_initial_exploration_files/figure-html/unnamed-chunk-16-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="01_initial_exploration_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>d_sum <span class="ot">&lt;-</span> <span class="fu">filter</span>(d, doy <span class="sc">&gt;=</span> thresh) <span class="sc">|&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">count_sum =</span> <span class="fu">cumsum</span>(count))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>dts <span class="ot">&lt;-</span> <span class="fu">calc_dates</span>(d_sum)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>dts_overall <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(dts_overall, </span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">mutate</span>(dts, <span class="at">type =</span> <span class="st">"Option 2: Threshold"</span>))</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>residents <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(doy <span class="sc">&lt;</span> thresh) <span class="sc">|&gt;</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">res_pop_min =</span> <span class="fu">min</span>(count), <span class="at">res_pop_max =</span> <span class="fu">max</span>(count), </span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">res_pop_median =</span> <span class="fu">median</span>(count), <span class="at">res_pop_mean =</span> <span class="fu">mean</span>(count)) <span class="sc">|&gt;</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), \(x) <span class="fu">round</span>(x, <span class="dv">1</span>)))</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">&lt;-</span> <span class="fu">plot_cum_explore</span>(d_sum, dts) <span class="sc">+</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> thresh, <span class="at">colour =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">label =</span> <span class="st">"Threshold"</span>, <span class="at">x =</span> thresh, <span class="at">y =</span> <span class="dv">1000</span>)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">&lt;-</span> <span class="fu">plot_model_explore</span>(<span class="at">d_raw =</span> g<span class="sc">$</span>model, <span class="at">d_pred =</span> d, <span class="at">dts =</span> dts, residents, <span class="at">resident_date =</span> thresh) <span class="sc">+</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">caption =</span> <span class="fu">paste0</span>(<span class="st">"Resident count stats calculated up to threshold date, "</span>, thresh))</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>g_opt2 <span class="ot">&lt;-</span> g1 <span class="sc">/</span> g2 <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Option 2: Use only dates after threshold"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="option-3" class="level3">
<h3 class="anchored" data-anchor-id="option-3">Option 3: Subtract the median resident count from all observations</h3>
<ul>
<li>Use entire date range</li>
<li>No threshold cutoff</li>
<li>Subtract the median resident count from the predicted observations, prior to calculating the cumulative counts</li>
<li>Calculate resident counts from predicted data before Day 240</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>residents <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(doy <span class="sc">&lt;</span> <span class="dv">240</span>) <span class="sc">|&gt;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">res_pop_min =</span> <span class="fu">min</span>(count), <span class="at">res_pop_max =</span> <span class="fu">max</span>(count), </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">res_pop_median =</span> <span class="fu">median</span>(count), <span class="at">res_pop_mean =</span> <span class="fu">mean</span>(count)) <span class="sc">|&gt;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), \(x) <span class="fu">round</span>(x, <span class="dv">1</span>)))</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>d_sum <span class="ot">&lt;-</span> <span class="fu">mutate</span>(d, </span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">count =</span> count <span class="sc">-</span> residents<span class="sc">$</span>res_pop_median,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">count_sum =</span> <span class="fu">cumsum</span>(count))</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>dts <span class="ot">&lt;-</span> <span class="fu">calc_dates</span>(d_sum)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>dts_overall <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(dts_overall, </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">mutate</span>(dts, <span class="at">type =</span> <span class="st">"Option 3: Subtraction"</span>))</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">&lt;-</span> <span class="fu">plot_cum_explore</span>(<span class="at">d_sum =</span> d_sum, <span class="at">dts =</span> dts) <span class="sc">+</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">225</span>, <span class="at">y =</span> <span class="dv">1000</span>,</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Remove "</span>, </span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>                          residents<span class="sc">$</span>res_pop_median, </span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>                          <span class="st">" from all counts</span><span class="sc">\n</span><span class="st">before calcuating cumuative sum"</span>))</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">&lt;-</span> <span class="fu">plot_model_explore</span>(<span class="at">d_raw =</span> g<span class="sc">$</span>model, <span class="at">d_pred =</span> d, <span class="at">dts =</span> dts, residents, <span class="at">resident_date =</span> <span class="dv">240</span>) <span class="sc">+</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">caption =</span> <span class="st">"Local count stats calculated up to Day 240"</span>)</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>g_opt3 <span class="ot">&lt;-</span> g1 <span class="sc">/</span> g2 <span class="sc">+</span> <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Option 3: Subtract median first"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="comparing-our-options" class="level3">
<h3 class="anchored" data-anchor-id="comparing-our-options">Comparing our options</h3>
<p>In each figure the red dots represent the 5%, 25%, 50%, 75% and 95% dates calculated based on the cumulative counts (top figure, dotted lines show the percentiles).</p>
<p>The bottom figure shows the raw counts, with the GAM model overlaid, the pink windows indicate 5%-95% and 25%-75% date ranges. The arrow on the left indicates which predicted values were included in the local count statistics.</p>
<p>Note that the only two things that really change in this example are the initial 5% date (becomes increasingly later with each option) and the calculation of the “local” population statistics (because in Option 1 and Option 2, they’re based on the same set of data, but in Option 2, we use a threshold to define before and after the expected start of migration.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>g_opt1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="01_initial_exploration_files/figure-html/unnamed-chunk-19-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="01_initial_exploration_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>g_opt2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="01_initial_exploration_files/figure-html/unnamed-chunk-19-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="01_initial_exploration_files/figure-html/unnamed-chunk-19-2.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>g_opt3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><a href="01_initial_exploration_files/figure-html/unnamed-chunk-19-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="01_initial_exploration_files/figure-html/unnamed-chunk-19-3.png" class="img-fluid figure-img" width="672"></a></p>
</figure>
</div>
</div>
</div>
<p>However in this example (and in many that I’ve looked at), this only really affects the first, 5%, Date value.</p>
<p>Here are the dates calculated for each percentiles using the different methods in this example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>dts_overall <span class="sc">|&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">contains</span>(<span class="st">"count"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">"perc"</span>, <span class="at">values_from =</span> <span class="st">"doy_passage"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  type                       p05   p25   p50   p75   p95
  &lt;chr&gt;                    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 Option 1: No Adjustments   248   262   268   273   281
2 Option 2: Threshold        251   262   268   273   281
3 Option 3: Subtraction      254   263   268   273   281</code></pre>
</div>
</div>
</section>
<section id="steffis-suggested-approach-1" class="level3">
<h3 class="anchored" data-anchor-id="steffis-suggested-approach-1">Steffi’s suggested approach</h3>
<p><strong>I suggest we use Option 3: Subtracting the median local numbers.</strong></p>
<p>I think that Option 1 gives us an artifically early start to migration as it starts cumulating counts over resident bird observations.</p>
<p>I think that Option 2 works, but is potentially overly complicated. I’m also not convinced that it completely avoids the issue of resident birds.</p>
<p>On the other hand I find Option 3</p>
<ul>
<li>Reasonable</li>
<li>Easy to explain</li>
<li>Visually, it looks the most ‘right’ (to me at any rate)</li>
<li>It seems to result in more conservative numbers</li>
</ul>
<p>Other options</p>
<ul>
<li>We could also just not use the 5% and 95% metrics</li>
<li>I could run all three methods on the full data set and we could check them all together.</li>
</ul>
</section>
</section>
<section id="reproducibility" class="level2">
<h2 class="anchored" data-anchor-id="reproducibility">Reproducibility</h2>
<div class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Session Info
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">session_info</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>─ Session info ───────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.3.2 (2023-10-31)
 os       Ubuntu 22.04.3 LTS
 system   x86_64, linux-gnu
 ui       X11
 language en_CA:en
 collate  en_CA.UTF-8
 ctype    en_CA.UTF-8
 tz       America/Winnipeg
 date     2024-02-09
 pandoc   3.1.1 @ /usr/lib/rstudio/resources/app/bin/quarto/bin/tools/ (via rmarkdown)

─ Packages ───────────────────────────────────────────────────────────────────
 package      * version  date (UTC) lib source
 bit            4.0.5    2022-11-15 [1] CRAN (R 4.3.0)
 bit64          4.0.5    2020-08-30 [1] CRAN (R 4.3.0)
 boot           1.3-28   2021-05-03 [4] CRAN (R 4.2.0)
 cachem         1.0.8    2023-05-01 [1] CRAN (R 4.3.0)
 callr          3.7.3    2022-11-02 [1] CRAN (R 4.3.0)
 cellranger     1.1.0    2016-07-27 [1] CRAN (R 4.3.0)
 cli            3.6.2    2023-12-11 [1] CRAN (R 4.3.2)
 codetools      0.2-19   2023-02-01 [4] CRAN (R 4.2.2)
 colorspace     2.1-0    2023-01-23 [1] CRAN (R 4.3.0)
 crayon         1.5.2    2022-09-29 [1] CRAN (R 4.3.0)
 devtools       2.4.5    2022-10-11 [1] CRAN (R 4.3.0)
 DHARMa         0.4.6    2022-09-08 [1] CRAN (R 4.3.1)
 digest         0.6.34   2024-01-11 [1] CRAN (R 4.3.2)
 doParallel     1.0.17   2022-02-07 [1] CRAN (R 4.3.1)
 dplyr        * 1.1.4    2023-11-17 [1] CRAN (R 4.3.2)
 ellipsis       0.3.2    2021-04-29 [1] CRAN (R 4.3.0)
 evaluate       0.23     2023-11-01 [1] CRAN (R 4.3.1)
 fansi          1.0.6    2023-12-08 [1] CRAN (R 4.3.2)
 farver         2.1.1    2022-07-06 [1] CRAN (R 4.3.0)
 fastmap        1.1.1    2023-02-24 [1] CRAN (R 4.3.0)
 forcats      * 1.0.0    2023-01-29 [1] CRAN (R 4.3.0)
 foreach        1.5.2    2022-02-02 [1] CRAN (R 4.3.0)
 fs             1.6.3    2023-07-20 [1] CRAN (R 4.3.1)
 gamm4          0.2-6    2020-04-03 [1] CRAN (R 4.3.1)
 gap            1.5-3    2023-08-26 [1] CRAN (R 4.3.1)
 gap.datasets   0.0.6    2023-08-25 [1] CRAN (R 4.3.1)
 generics       0.1.3    2022-07-05 [1] CRAN (R 4.3.0)
 GGally         2.1.2    2021-06-21 [1] CRAN (R 4.3.1)
 ggplot2      * 3.4.4    2023-10-12 [1] CRAN (R 4.3.1)
 glue           1.7.0    2024-01-09 [1] CRAN (R 4.3.2)
 gridExtra      2.3      2017-09-09 [1] CRAN (R 4.3.0)
 gtable         0.3.4    2023-08-21 [1] CRAN (R 4.3.1)
 hms            1.1.3    2023-03-21 [1] CRAN (R 4.3.0)
 htmltools      0.5.7    2023-11-03 [1] CRAN (R 4.3.1)
 htmlwidgets    1.6.4    2023-12-06 [1] CRAN (R 4.3.2)
 httpuv         1.6.12   2023-10-23 [1] CRAN (R 4.3.1)
 iterators      1.0.14   2022-02-05 [1] CRAN (R 4.3.0)
 jsonlite       1.8.8    2023-12-04 [1] CRAN (R 4.3.2)
 KernSmooth     2.23-22  2023-07-10 [1] CRAN (R 4.3.1)
 knitr          1.45     2023-10-30 [1] CRAN (R 4.3.1)
 labeling       0.4.3    2023-08-29 [1] CRAN (R 4.3.1)
 later          1.3.1    2023-05-02 [1] CRAN (R 4.3.1)
 lattice        0.22-5   2023-10-24 [4] CRAN (R 4.3.1)
 lifecycle      1.0.4    2023-11-07 [1] CRAN (R 4.3.2)
 lme4           1.1-35.1 2023-11-05 [1] CRAN (R 4.3.1)
 lubridate    * 1.9.3    2023-09-27 [1] CRAN (R 4.3.1)
 magrittr       2.0.3    2022-03-30 [1] CRAN (R 4.3.0)
 MASS           7.3-60   2023-05-04 [4] CRAN (R 4.3.1)
 Matrix         1.6-1.1  2023-09-18 [1] CRAN (R 4.3.1)
 matrixStats    1.0.0    2023-06-02 [1] CRAN (R 4.3.1)
 memoise        2.0.1    2021-11-26 [1] CRAN (R 4.3.0)
 mgcv         * 1.9-0    2023-07-11 [1] CRAN (R 4.3.1)
 mgcViz         0.1.11   2023-10-06 [1] CRAN (R 4.3.1)
 mime           0.12     2021-09-28 [1] CRAN (R 4.3.0)
 miniUI         0.1.1.1  2018-05-18 [1] CRAN (R 4.3.0)
 minqa          1.2.6    2023-09-11 [1] CRAN (R 4.3.1)
 munsell        0.5.0    2018-06-12 [1] CRAN (R 4.3.0)
 nlme         * 3.1-163  2023-08-09 [4] CRAN (R 4.3.1)
 nloptr         2.0.3    2022-05-26 [1] CRAN (R 4.3.0)
 patchwork    * 1.2.0    2024-01-08 [1] CRAN (R 4.3.2)
 pillar         1.9.0    2023-03-22 [1] CRAN (R 4.3.0)
 pkgbuild       1.4.2    2023-06-26 [1] CRAN (R 4.3.1)
 pkgconfig      2.0.3    2019-09-22 [1] CRAN (R 4.3.0)
 pkgload        1.3.3    2023-09-22 [1] CRAN (R 4.3.1)
 plyr           1.8.9    2023-10-02 [1] CRAN (R 4.3.1)
 prettyunits    1.2.0    2023-09-24 [1] CRAN (R 4.3.1)
 processx       3.8.2    2023-06-30 [1] CRAN (R 4.3.1)
 profvis        0.3.8    2023-05-02 [1] CRAN (R 4.3.1)
 promises       1.2.1    2023-08-10 [1] CRAN (R 4.3.1)
 ps             1.7.5    2023-04-18 [1] CRAN (R 4.3.0)
 purrr        * 1.0.2    2023-08-10 [1] CRAN (R 4.3.1)
 qgam           1.3.4    2021-11-22 [1] CRAN (R 4.3.1)
 R6             2.5.1    2021-08-19 [1] CRAN (R 4.3.0)
 rbibutils      2.2.16   2023-10-25 [1] CRAN (R 4.3.1)
 RColorBrewer   1.1-3    2022-04-03 [1] CRAN (R 4.3.0)
 Rcpp           1.0.11   2023-07-06 [1] CRAN (R 4.3.1)
 Rdpack         2.5      2023-08-21 [1] CRAN (R 4.3.1)
 readr        * 2.1.4    2023-02-10 [1] CRAN (R 4.3.0)
 readxl       * 1.4.3    2023-07-06 [1] CRAN (R 4.3.1)
 remotes        2.4.2.1  2023-07-18 [1] CRAN (R 4.3.1)
 reshape        0.8.9    2022-04-12 [1] CRAN (R 4.3.1)
 rlang          1.1.3    2024-01-10 [1] CRAN (R 4.3.2)
 rmarkdown      2.25     2023-09-18 [1] CRAN (R 4.3.1)
 rstudioapi     0.15.0   2023-07-07 [1] CRAN (R 4.3.1)
 scales         1.3.0    2023-11-28 [1] CRAN (R 4.3.2)
 sessioninfo    1.2.2    2021-12-06 [1] CRAN (R 4.3.0)
 shiny          1.7.5.1  2023-10-14 [1] CRAN (R 4.3.1)
 stringi        1.8.3    2023-12-11 [1] CRAN (R 4.3.2)
 stringr      * 1.5.1    2023-11-14 [1] CRAN (R 4.3.2)
 tibble       * 3.2.1    2023-03-20 [1] CRAN (R 4.3.0)
 tidyr        * 1.3.0    2023-01-24 [1] CRAN (R 4.3.0)
 tidyselect     1.2.0    2022-10-10 [1] CRAN (R 4.3.0)
 tidyverse    * 2.0.0    2023-02-22 [1] CRAN (R 4.3.0)
 timechange     0.2.0    2023-01-11 [1] CRAN (R 4.3.0)
 tzdb           0.4.0    2023-05-12 [1] CRAN (R 4.3.1)
 urlchecker     1.0.1    2021-11-30 [1] CRAN (R 4.3.0)
 usethis        2.2.2    2023-07-06 [1] CRAN (R 4.3.1)
 utf8           1.2.4    2023-10-22 [1] CRAN (R 4.3.1)
 vctrs          0.6.5    2023-12-01 [1] CRAN (R 4.3.2)
 viridis        0.6.4    2023-07-22 [1] CRAN (R 4.3.1)
 viridisLite    0.4.2    2023-05-02 [1] CRAN (R 4.3.1)
 vroom          1.6.4    2023-10-02 [1] CRAN (R 4.3.1)
 withr          3.0.0    2024-01-16 [1] CRAN (R 4.3.2)
 xfun           0.41     2023-11-01 [1] CRAN (R 4.3.1)
 xtable         1.8-4    2019-04-21 [1] CRAN (R 4.3.0)
 yaml           2.3.8    2023-12-11 [1] CRAN (R 4.3.2)

 [1] /home/steffi/R/x86_64-pc-linux-gnu-library/4.3
 [2] /usr/local/lib/R/site-library
 [3] /usr/lib/R/site-library
 [4] /usr/lib/R/library

──────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
</div>
</div>
</div>
</div>


</section>


<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>https://noamross.github.io/gams-in-r-course/chapter1<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Similar to a method I used in a paper with Matt Reudink on Bluebirds and also one on Swifts (companion to the one you referenced). We used this to calculate a threshold for latitude to define the start and end of migration by population postition rather than counts, though.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
  </div>
  <div class="nav-page nav-page-next">
      <a href="./02_calculate_metrics.html" class="pagination-link" aria-label="Calculate Metrics">
        <span class="nav-page-text">Calculate Metrics</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/steffilazerte/vulture_migration/edit/main/01_initial_exploration.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/steffilazerte/vulture_migration/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer><script>var lightboxQuarto = GLightbox({"selector":".lightbox","descPosition":"bottom","closeEffect":"zoom","loop":false,"openEffect":"zoom"});
window.onload = () => {
  lightboxQuarto.on('slide_before_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    const href = trigger.getAttribute('href');
    if (href !== null) {
      const imgEl = window.document.querySelector(`a[href="${href}"] img`);
      if (imgEl !== null) {
        const srcAttr = imgEl.getAttribute("src");
        if (srcAttr && srcAttr.startsWith("data:")) {
          slideConfig.href = srcAttr;
        }
      }
    } 
  });

  lightboxQuarto.on('slide_after_load', (data) => {
    const { slideIndex, slideNode, slideConfig, player, trigger } = data;
    if (window.Quarto?.typesetMath) {
      window.Quarto.typesetMath(slideNode);
    }
  });

};
          </script>




</body></html>